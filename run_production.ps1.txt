<#
.SYNOPSIS
  Agents‚Äë00 ‚Äì Production one‚Äëclick launcher (PowerShell)
#>

# 1Ô∏è‚É£  Move to script directory
Set-Location $PSScriptRoot

# 2Ô∏è‚É£  Load .env (if present)
$envFile = Join-Path $PSScriptRoot ".env"
if (Test-Path $envFile) {
    Get-Content $envFile | Where-Object { $_ -notmatch '^#' } |
        ForEach-Object {
            $pair = $_ -split '=',2
            [System.Environment]::SetEnvironmentVariable($pair[0], $pair[1])
        }
} else {
    Write-Warning ".env not found ‚Äì using defaults"
}

# 3Ô∏è‚É£  Build / pull latest images
docker compose build --pull

# 4Ô∏è‚É£  Run DB migrations (uncomment the one you need)
# docker compose run --rm backend alembic upgrade head
# docker compose run --rm backend npx prisma migrate deploy

# 5Ô∏è‚É£  Start everything in detached mode
docker compose up -d

# 6Ô∏è‚É£  Wait for health endpoint
Write-Host "‚è≥ Waiting for services to become healthy..."
do {
    Start-Sleep -Seconds 2
    $status = Invoke-RestMethod -Uri http://localhost:8000/health -ErrorAction SilentlyContinue
} while ($null -eq $status -or $status -notmatch "OK")
Write-Host "‚úÖ All services healthy!"

# 7Ô∏è‚É£  Open UI in default browser
Start-Process "http://localhost:3000"

Write-Host "üöÄ Production stack is up and running."